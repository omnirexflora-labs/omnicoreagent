# deep_coder/Dockerfile.sandbox
FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    PATH="/home/coder/.local/bin:/home/coder/venv/bin:$PATH"

# Install comprehensive developer toolset
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        # Core
        ca-certificates \
        curl \
        wget \
        git \
        bash \
        zsh \
        sudo \
        # Build & C
        build-essential \
        gcc \
        g++ \
        make \
        cmake \
        pkg-config \
        # Python
        python3 \
        python3-pip \
        python3-venv \
        python3-dev \
        python3-setuptools \
        # Node.js & JS
        nodejs \
        npm \
        # Editors
        nano \
        vim \
        less \
        # Shell utils
        jq \
        yq \
        tree \
        htop \
        psmisc \
        procps \
        net-tools \
        iproute2 \
        # Text processing
        grep \
        sed \
        gawk \
        xz-utils \
        unzip \
        zip \
        # Version control
        rsync \
        openssh-client \
        # Shell linting
        shellcheck \
        # Other essentials
        locales \
        tzdata \
    && rm -rf /var/lib/apt/lists/*

# Generate en_US.UTF-8 locale
RUN locale-gen en_US.UTF-8

ENV LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    LC_ALL=en_US.UTF-8

# Create unprivileged user (avoid UID/GID conflicts)
RUN groupadd -g 1001 coder && \
    useradd -u 1001 -g 1001 --create-home --shell /bin/bash coder

# Set up workspace with proper ownership
RUN mkdir -p /home/coder/workspace && \
    chown -R coder:coder /home/coder

# Switch to non-root user
USER coder
WORKDIR /home/coder

# Create Python virtual environment
RUN python3 -m venv venv

# Configure npm for user install
RUN mkdir -p /home/coder/.local && \
    npm config set prefix '/home/coder/.local'

# Upgrade pip and install core Python tools
RUN /home/coder/venv/bin/pip install --no-cache-dir --upgrade pip setuptools wheel

# Install TypeScript, ts-node, and common JS tools
RUN npm install -g \
        typescript@5.4.5 \
        ts-node@10.9.2 \
        eslint@8.57.0 \
        prettier@3.3.3

# Install Python dev tools in venv
RUN /home/coder/venv/bin/pip install --no-cache-dir \
        pytest \
        pytest-asyncio \
        black \
        flake8 \
        mypy \
        pylint \
        types-requests \
        types-redis

# Final workspace
WORKDIR /home/coder/workspace

# Keep container alive indefinitely
CMD ["tail", "-f", "/dev/null"]